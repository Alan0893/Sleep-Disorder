<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Health Recommendation System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B6F47 0%, #D4C4A8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            transition: all 0.5s ease;
        }

        .main-content.has-results {
            display: grid;
            grid-template-columns: 1fr 2fr;
            align-items: start;
        }

        .form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
            max-width: 500px;
            transition: all 0.5s ease;
        }

        .main-content.has-results .form-container {
            max-width: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8B6F47;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #8B6F47 0%, #A0826D 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .results-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            width: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .results-container.show {
            display: block;
            opacity: 1;
        }

        .cluster-badge {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
        }

        .cluster-0 { background: linear-gradient(135deg, #A0826D, #8B6F47); }
        .cluster-1 { background: linear-gradient(135deg, #8B5A3C, #6B4423); }
        .cluster-2 { background: linear-gradient(135deg, #C4A484, #A0826D); }
        .cluster-3 { background: linear-gradient(135deg, #9B7355, #7A5A3F); }

        .cluster-badge h2 {
            color: white;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .cluster-badge p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1em;
        }

        .risk-gauge {
            text-align: center;
            margin: 20px 0;
        }

        .risk-gauge .gauge-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .risk-low { color: #2ecc71; }
        .risk-moderate { color: #f39c12; }
        .risk-high { color: #e74c3c; }

        .description-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #8B6F47;
        }

        .recommendations-section {
            margin: 20px 0;
        }

        .recommendation-category {
            background: #E8DCC6;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #8B6F47;
        }

        .recommendation-category h4 {
            color: #6B4423;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .recommendation-category ul {
            list-style: none;
            padding-left: 0;
        }

        .recommendation-category li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .recommendation-category li:before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: #6B4423;
            font-weight: bold;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table th {
            background: #8B6F47;
            color: white;
            font-weight: bold;
        }

        .comparison-table tr:hover {
            background: #f5f5f5;
        }

        .metric-diff {
            font-weight: bold;
        }

        .metric-diff.positive {
            color: #2ecc71;
        }

        .metric-diff.negative {
            color: #e74c3c;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        @media (max-width: 1024px) {
            .main-content.has-results {
                grid-template-columns: 1fr;
            }
            
            .form-container {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sleep Health Recommendation System</h1>
            <p>Get personalized sleep health recommendations based on your lifestyle and health metrics</p>
        </div>

        <div class="main-content">
            <div class="form-container">
                <h2 style="margin-bottom: 20px; color: #333;">Enter Your Information</h2>
                <form id="recommendationForm">
                    <div class="form-group">
                        <label for="age">Age (years)</label>
                        <input type="number" id="age" name="age" min="18" max="100" value="35" required>
                    </div>

                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender" name="gender" required>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="occupation">Occupation</label>
                        <select id="occupation" name="occupation" required>
                            <option value="Engineer">Engineer</option>
                            <option value="Doctor">Doctor</option>
                            <option value="Nurse">Nurse</option>
                            <option value="Lawyer">Lawyer</option>
                            <option value="Teacher">Teacher</option>
                            <option value="Accountant">Accountant</option>
                            <option value="Salesperson">Salesperson</option>
                            <option value="Manager">Manager</option>
                            <option value="Software Engineer">Software Engineer</option>
                            <option value="Scientist">Scientist</option>
                            <option value="Sales Representative">Sales Representative</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sleep_duration">Sleep Duration (hours per night)</label>
                        <input type="number" id="sleep_duration" name="sleep_duration" min="4" max="12" step="0.1" value="7.5" required>
                    </div>

                    <div class="form-group">
                        <label for="quality_of_sleep">Sleep Quality (1-10 scale)</label>
                        <input type="number" id="quality_of_sleep" name="quality_of_sleep" min="1" max="10" step="0.1" value="8" required>
                    </div>

                    <div class="form-group">
                        <label for="physical_activity_level">Physical Activity Level (0-100)</label>
                        <input type="number" id="physical_activity_level" name="physical_activity_level" min="0" max="100" step="1" value="60" required>
                    </div>

                    <div class="form-group">
                        <label for="stress_level">Stress Level (1-10 scale)</label>
                        <input type="number" id="stress_level" name="stress_level" min="1" max="10" step="0.1" value="5" required>
                    </div>

                    <div class="form-group">
                        <label for="daily_steps">Daily Steps</label>
                        <input type="number" id="daily_steps" name="daily_steps" min="0" max="20000" value="8000" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="systolic_bp">Systolic BP (mmHg)</label>
                            <input type="number" id="systolic_bp" name="systolic_bp" min="80" max="200" value="120" required>
                        </div>

                        <div class="form-group">
                            <label for="diastolic_bp">Diastolic BP (mmHg)</label>
                            <input type="number" id="diastolic_bp" name="diastolic_bp" min="50" max="130" value="80" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="heart_rate">Heart Rate (bpm)</label>
                        <input type="number" id="heart_rate" name="heart_rate" min="40" max="120" value="72" required>
                    </div>

                    <div class="form-group">
                        <label for="bmi_category">BMI Category</label>
                        <select id="bmi_category" name="bmi_category" required>
                            <option value="Normal">Normal</option>
                            <option value="Overweight">Overweight</option>
                            <option value="Obese">Obese</option>
                        </select>
                    </div>

                    <button type="submit" class="btn">Get Recommendations</button>
                </form>
            </div>

            <div class="results-container" id="resultsContainer">
                <div class="loading" id="loading">
                    <p>Processing your information...</p>
                </div>

                <div id="resultsContent" style="display: none;">
                    <div class="cluster-badge" id="clusterBadge">
                        <h2 id="clusterName">Cluster Name</h2>
                        <p id="clusterDescription">Description</p>
                    </div>

                    <div class="risk-gauge">
                        <div class="gauge-value" id="riskValue">0%</div>
                        <div id="riskLevel">Risk Level</div>
                    </div>

                    <div class="description-box">
                        <h3>About Your Cluster</h3>
                        <p id="clusterAbout"></p>
                        <p style="margin-top: 10px;"><strong>Cluster Size:</strong> <span id="clusterSize"></span> people (<span id="clusterPercentage"></span>% of population)</p>
                    </div>

                    <div class="recommendations-section">
                        <h3 style="margin-bottom: 15px;">Personalized Recommendations</h3>
                        <div id="recommendations"></div>
                    </div>

                    <div class="chart-container full-width" style="margin: 20px 0;">
                        <h3 style="margin-bottom: 10px; text-align: center;">Your Position in Cluster Space</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #8B6F47;">
                            <p style="margin: 0; font-size: 14px; line-height: 1.6; margin-bottom: 10px;">
                                <strong>Understanding the Graph:</strong> This visualization shows your position in a space created by Principal Component Analysis (PCA). 
                                The axes represent combined health and lifestyle factors. Your position (yellow marker) shows where you fall relative to others in the dataset. 
                                Points of the same color belong to the same lifestyle-health profile cluster.
                            </p>
                            <div id="pcaLegend" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h4 style="text-align: center; margin-bottom: 10px;">2D View (PC1 vs PC2)</h4>
                            <canvas id="clusterVisualizationChart"></canvas>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h4 style="text-align: center; margin-bottom: 10px;">3D View (PC1, PC2, PC3)</h4>
                            <div id="clusterVisualization3D" style="height: 500px;"></div>
                        </div>
                    </div>

                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Your Value</th>
                                <th>Cluster Average</th>
                                <th>Difference</th>
                            </tr>
                        </thead>
                        <tbody id="comparisonTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('recommendationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                occupation: document.getElementById('occupation').value,
                sleep_duration: document.getElementById('sleep_duration').value,
                quality_of_sleep: document.getElementById('quality_of_sleep').value,
                physical_activity_level: document.getElementById('physical_activity_level').value,
                stress_level: document.getElementById('stress_level').value,
                daily_steps: document.getElementById('daily_steps').value,
                blood_pressure: document.getElementById('systolic_bp').value + '/' + document.getElementById('diastolic_bp').value,
                heart_rate: document.getElementById('heart_rate').value,
                bmi_category: document.getElementById('bmi_category').value
            };

            // Show loading
            document.getElementById('resultsContainer').classList.add('show');
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultsContent').style.display = 'none';

            try {
                const response = await fetch('/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                displayResults(data);
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        });

        function displayResults(data) {
            // Add class to main-content to trigger layout change
            document.querySelector('.main-content').classList.add('has-results');
            
            // Show results content
            document.getElementById('resultsContent').style.display = 'block';
            
            // Update cluster badge
            const badge = document.getElementById('clusterBadge');
            badge.className = `cluster-badge cluster-${data.cluster}`;
            document.getElementById('clusterName').textContent = data.cluster_name;
            document.getElementById('clusterDescription').textContent = data.description;
            
            // Update risk gauge
            const riskValue = document.getElementById('riskValue');
            riskValue.textContent = data.risk_percentage.toFixed(1) + '%';
            riskValue.className = `gauge-value risk-${data.risk_level.toLowerCase()}`;
            document.getElementById('riskLevel').textContent = data.risk_level + ' RISK';
            document.getElementById('riskLevel').className = `risk-${data.risk_level.toLowerCase()}`;
            
            // Update description
            document.getElementById('clusterAbout').textContent = data.description;
            document.getElementById('clusterSize').textContent = data.cluster_size;
            document.getElementById('clusterPercentage').textContent = data.cluster_percentage;
            
            // Display recommendations
            const recommendationsDiv = document.getElementById('recommendations');
            recommendationsDiv.innerHTML = '';
            
            data.recommendations.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'recommendation-category';
                categoryDiv.innerHTML = `
                    <h4>${category.category}</h4>
                    <ul>
                        ${category.items.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                `;
                recommendationsDiv.appendChild(categoryDiv);
            });
            
            // Create comparison table
            createComparisonTable(data);
            
            // Create PCA legend
            createPCALegend(data);
            
            // Create cluster visualization
            createClusterVisualization(data);
        }

        function createComparisonTable(data) {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            
            const metrics = [
                { key: 'age', label: 'Age', unit: 'years' },
                { key: 'sleep_duration', label: 'Sleep Duration', unit: 'hours' },
                { key: 'quality_of_sleep', label: 'Sleep Quality', unit: '/10' },
                { key: 'physical_activity_level', label: 'Physical Activity', unit: '' },
                { key: 'stress_level', label: 'Stress Level', unit: '/10' },
                { key: 'heart_rate', label: 'Heart Rate', unit: 'bpm' },
                { key: 'daily_steps', label: 'Daily Steps', unit: 'steps' },
                { key: 'systolic_bp', label: 'Systolic BP', unit: 'mmHg' },
                { key: 'diastolic_bp', label: 'Diastolic BP', unit: 'mmHg' }
            ];
            
            metrics.forEach(metric => {
                const userVal = data.user_metrics[metric.key];
                const clusterVal = data.cluster_averages[metric.key];
                const diff = userVal - clusterVal;
                const diffClass = diff >= 0 ? 'positive' : 'negative';
                const diffSign = diff >= 0 ? '+' : '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${metric.label}</strong></td>
                    <td>${userVal.toFixed(1)} ${metric.unit}</td>
                    <td>${clusterVal.toFixed(1)} ${metric.unit}</td>
                    <td class="metric-diff ${diffClass}">${diffSign}${diff.toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        let clusterChart = null;

        function createPCALegend(data) {
            const legendDiv = document.getElementById('pcaLegend');
            legendDiv.innerHTML = '';
            
            const pcs = ['PC1', 'PC2', 'PC3'];
            const pcNames = {
                'PC1': 'Cardiovascular-Metabolic Risk Factor',
                'PC2': 'Age-Associated Sleep Health',
                'PC3': 'Physical Activity Lifestyle'
            };
            const pcColors = ['#8B6F47', '#A0826D', '#6B4423'];
            
            pcs.forEach((pc, idx) => {
                const pcDiv = document.createElement('div');
                pcDiv.style.background = 'white';
                pcDiv.style.padding = '10px';
                pcDiv.style.borderRadius = '5px';
                pcDiv.style.border = `2px solid ${pcColors[idx]}`;
                
                const variance = data.variance_explained[pc].toFixed(1);
                pcDiv.innerHTML = `<strong style="color: ${pcColors[idx]};">${pc}: ${pcNames[pc]}</strong><br><span style="font-size: 11px; color: #666;">${variance}% variance</span><br>`;
                
                // Get top contributing features (absolute value)
                const features = Object.keys(data.pca_loadings);
                const contributions = features.map(f => ({
                    name: f.replace(/_/g, ' ').replace('Encoded', '').trim(),
                    value: data.pca_loadings[f][pc],
                    absValue: Math.abs(data.pca_loadings[f][pc])
                }));
                
                // Sort by absolute value and get top 5
                contributions.sort((a, b) => b.absValue - a.absValue);
                const topFeatures = contributions.slice(0, 5);
                
                const featureList = document.createElement('ul');
                featureList.style.margin = '5px 0 0 0';
                featureList.style.paddingLeft = '20px';
                featureList.style.fontSize = '12px';
                
                topFeatures.forEach(f => {
                    const li = document.createElement('li');
                    const sign = f.value >= 0 ? '+' : '-';
                    const color = f.value >= 0 ? '#2ecc71' : '#e74c3c';
                    li.innerHTML = `<span style="color: ${color};">${sign}</span> ${f.name} <span style="color: #666; font-size: 11px;">(${f.value.toFixed(2)})</span>`;
                    featureList.appendChild(li);
                });
                
                pcDiv.appendChild(featureList);
                legendDiv.appendChild(pcDiv);
            });
        }

        function createClusterVisualization(data) {
            const ctx = document.getElementById('clusterVisualizationChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (clusterChart) {
                clusterChart.destroy();
            }
            
            // Cluster colors matching the badge colors
            const clusterColors = [
                'rgba(46, 204, 113, 0.6)',  // Cluster 0 - green
                'rgba(231, 76, 60, 0.6)',   // Cluster 1 - red
                'rgba(52, 152, 219, 0.6)',  // Cluster 2 - blue
                'rgba(243, 156, 18, 0.6)'  // Cluster 3 - orange
            ];
            
            const clusterBorderColors = [
                'rgba(46, 204, 113, 1)',
                'rgba(231, 76, 60, 1)',
                'rgba(52, 152, 219, 1)',
                'rgba(243, 156, 18, 1)'
            ];
            
            // Prepare datasets for each cluster
            const datasets = [];
            
            // Add cluster sample points
            for (let i = 0; i < 4; i++) {
                if (data.cluster_samples[i]) {
                    const clusterData = data.cluster_samples[i];
                    datasets.push({
                        label: `Cluster ${i}`,
                        data: clusterData.pc1.map((x, idx) => ({
                            x: x,
                            y: clusterData.pc2[idx]
                        })),
                        backgroundColor: clusterColors[i],
                        borderColor: clusterBorderColors[i],
                        borderWidth: 1,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    });
                }
            }
            
            // Add cluster centroids
            const centroidData = data.cluster_centroids.map((centroid, i) => ({
                x: centroid.pc1,
                y: centroid.pc2
            }));
            
            datasets.push({
                label: 'Cluster Centroids',
                data: centroidData,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                borderColor: 'rgba(0, 0, 0, 1)',
                borderWidth: 2,
                pointRadius: 8,
                pointHoverRadius: 10,
                pointStyle: 'star'
            });
            
            // Add user's position
            datasets.push({
                label: 'Your Position',
                data: [{
                    x: data.user_pca_coords.pc1,
                    y: data.user_pca_coords.pc2
                }],
                backgroundColor: 'rgba(255, 255, 0, 0.9)',
                borderColor: 'rgba(255, 215, 0, 1)',
                borderWidth: 3,
                pointRadius: 10,
                pointHoverRadius: 12,
                pointStyle: 'circle'
            });
            
            clusterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cluster Visualization in PCA Space',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '(' + context.parsed.x.toFixed(2) + ', ' + context.parsed.y.toFixed(2) + ')';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: `PC1: Cardiovascular-Metabolic Risk (${data.variance_explained.PC1.toFixed(1)}%)`,
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `PC2: Age-Associated Sleep Health (${data.variance_explained.PC2.toFixed(1)}%)`,
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Create 3D visualization
            createClusterVisualization3D(data);
        }

        function createClusterVisualization3D(data) {
            const clusterColors = [
                'rgba(46, 204, 113, 0.6)',  // Cluster 0 - green
                'rgba(231, 76, 60, 0.6)',   // Cluster 1 - red
                'rgba(52, 152, 219, 0.6)',  // Cluster 2 - blue
                'rgba(243, 156, 18, 0.6)'  // Cluster 3 - orange
            ];
            
            const traces = [];
            
            // Add cluster sample points
            for (let i = 0; i < 4; i++) {
                if (data.cluster_samples[i]) {
                    const clusterData = data.cluster_samples[i];
                    // Get PC3 data from cluster samples if available, otherwise use centroids
                    const pc3Data = clusterData.pc3 || Array(clusterData.pc1.length).fill(data.cluster_centroids[i].pc3);
                    
                    traces.push({
                        x: clusterData.pc1,
                        y: clusterData.pc2,
                        z: pc3Data,
                        mode: 'markers',
                        type: 'scatter3d',
                        name: `Cluster ${i}`,
                        marker: {
                            size: 4,
                            color: clusterColors[i],
                            line: {
                                color: clusterColors[i].replace('0.6', '1'),
                                width: 1
                            }
                        }
                    });
                }
            }
            
            // Add cluster centroids
            const centroidX = data.cluster_centroids.map(c => c.pc1);
            const centroidY = data.cluster_centroids.map(c => c.pc2);
            const centroidZ = data.cluster_centroids.map(c => c.pc3);
            
            traces.push({
                x: centroidX,
                y: centroidY,
                z: centroidZ,
                mode: 'markers',
                type: 'scatter3d',
                name: 'Cluster Centroids',
                marker: {
                    size: 8,
                    color: 'rgba(0, 0, 0, 0.8)',
                    symbol: 'diamond',
                    line: {
                        color: 'rgba(0, 0, 0, 1)',
                        width: 2
                    }
                }
            });
            
            // Add user's position
            traces.push({
                x: [data.user_pca_coords.pc1],
                y: [data.user_pca_coords.pc2],
                z: [data.user_pca_coords.pc3],
                mode: 'markers',
                type: 'scatter3d',
                name: 'Your Position',
                marker: {
                    size: 12,
                    color: 'rgba(255, 255, 0, 0.9)',
                    line: {
                        color: 'rgba(255, 215, 0, 1)',
                        width: 3
                    }
                }
            });
            
            const layout = {
                scene: {
                    xaxis: {
                        title: `PC1: Cardiovascular-Metabolic Risk (${data.variance_explained.PC1.toFixed(1)}%)`,
                        titlefont: { size: 11 }
                    },
                    yaxis: {
                        title: `PC2: Age-Associated Sleep Health (${data.variance_explained.PC2.toFixed(1)}%)`,
                        titlefont: { size: 11 }
                    },
                    zaxis: {
                        title: `PC3: Physical Activity Lifestyle (${data.variance_explained.PC3.toFixed(1)}%)`,
                        titlefont: { size: 11 }
                    },
                    camera: {
                        eye: { x: 1.5, y: 1.5, z: 1.5 }
                    }
                },
                margin: { l: 0, r: 0, t: 0, b: 0 },
                height: 400
            };
            
            Plotly.newPlot('clusterVisualization3D', traces, layout, {responsive: true});
        }
    </script>
</body>
</html>

